---
import Layout from '../layouts/Layout.astro';
import FileUpload from '../components/FileUpload.astro';
import ImagePreview from '../components/ImagePreview.astro';
import DeviceToggle from '../components/DeviceToggle.astro';
import OrientationToggle from '../components/OrientationToggle.astro';
import SizeList from '../components/SizeList.astro';
import Footer from '../components/Footer.astro';
import '../styles/global.css';

// SEO metadata
const title = 'Screenshot Resizer - Free iOS App Store Screenshot Tool';
const description = 'Resize screenshots for every iPhone and iPad size required by the App Store. Free, fast, browser-based tool that processes images locally for complete privacy. Supports 20+ screen sizes.';
const keywords = 'screenshot resizer, iOS screenshots, App Store screenshots, iPhone sizes, iPad sizes, screenshot tool, app store submission, free tool, browser-based';

// JSON-LD Structured Data for SoftwareApplication
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "Screenshot Resizer",
  "description": description,
  "url": "https://tools.dennislysenko.tech/screenshot-resizer",
  "applicationCategory": "UtilityApplication",
  "operatingSystem": "Any (Browser-based)",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD"
  },
  "featureList": [
    "Resize screenshots for 20+ iPhone and iPad screen sizes",
    "Batch download all resized screenshots as ZIP",
    "100% browser-based - no uploads required",
    "Privacy-focused - images never leave your device",
    "Support for portrait and landscape orientations",
    "Quick presets for common device sizes"
  ],
  "screenshot": "https://tools.dennislysenko.tech/og-image.jpg",
  "author": {
    "@type": "Person",
    "name": "Dennis Lysenko",
    "url": "https://dennislysenko.tech"
  },
  "browserRequirements": "Requires JavaScript. Works with modern browsers (Chrome, Firefox, Safari, Edge).",
  "softwareVersion": "1.0.0",
  "datePublished": "2025-01-15"
};
---

<Layout
  title={title}
  description={description}
  keywords={keywords}
  canonicalUrl="/screenshot-resizer"
  jsonLd={jsonLd}
>
  <main class="app-container">
    <div class="app-wrapper">
      <!-- Hero Section -->
      <header class="hero-section">
        <div class="hero-content">
          <div class="title-group">
            <h1 class="hero-title">Stop fighting App Store screenshot requirements</h1>
            <span class="beta-badge">BETA</span>
          </div>
          <p class="hero-description">
            Resize your screenshots for every iPhone and iPad size in seconds. Free, fast, and runs entirely in your browser.
          </p>
        </div>
      </header>

      <!-- Main Content -->
      <div class="content-grid">
        <!-- Upload Section -->
        <section class="upload-section">
          <FileUpload />
          <ImagePreview />
        </section>

        <!-- Configuration Sidebar -->
        <aside class="config-sidebar">
          <div class="config-card">
            <h2 class="config-title">Configuration</h2>

            <div class="config-group">
              <DeviceToggle />
            </div>

            <div class="config-group">
              <OrientationToggle />
            </div>

            <div class="config-group">
              <SizeList />
            </div>

            <!-- Error Message -->
            <div id="error-container" style="display: none;">
              <div class="error-message">
                <span id="error-text"></span>
              </div>
            </div>

            <!-- Download Section -->
            <div class="download-section">
              <button
                id="download-button"
                class="btn-primary"
                disabled
              >
                <span id="button-text">Download Screenshots</span>
                <span id="button-spinner" class="spinner" style="display: none;"></span>
              </button>

              <p id="selected-count" class="selected-count">
                Select sizes to download
              </p>
            </div>
          </div>
        </aside>
      </div>
    </div>

    <Footer />
  </main>
</Layout>

<script>
  import { getSizesByDevice, getDimensionsForOrientation } from '../data/screenshotSizes';
  import { isImageFile } from '../utils/imageResize';
  import { createScreenshotZip, downloadBlob, generateZipFilename } from '../utils/zipGenerator';
  import type { AppState, DeviceMode, Orientation } from '../utils/types';

  // Global state
  const state: AppState = {
    uploadedFile: null,
    uploadedImageUrl: null,
    deviceMode: 'iphone',
    orientation: 'portrait',
    selectedSizes: new Set<string>(),
    availableSizes: getSizesByDevice('iphone'),
    error: null,
    isProcessing: false,
  };

  // DOM Elements
  const uploadContainer = document.getElementById('upload-container')!;
  const fileInput = document.getElementById('file-input') as HTMLInputElement;
  const previewContainer = document.getElementById('image-preview-container')!;
  const previewImage = document.getElementById('preview-image') as HTMLImageElement;
  const imageDimensions = document.getElementById('image-dimensions')!;
  const clearButton = document.getElementById('clear-button')!;
  const deviceToggle = document.getElementById('device-toggle')!;
  const orientationToggle = document.getElementById('orientation-toggle')!;
  const sizeListContainer = document.getElementById('size-list-container')!;
  const selectAllCheckbox = document.getElementById('select-all') as HTMLInputElement;
  const downloadButton = document.getElementById('download-button') as HTMLButtonElement;
  const buttonText = document.getElementById('button-text')!;
  const buttonSpinner = document.getElementById('button-spinner')!;
  const selectedCount = document.getElementById('selected-count')!;
  const errorContainer = document.getElementById('error-container')!;
  const errorText = document.getElementById('error-text')!;

  // Initialize
  init();

  function init() {
    setupFileUpload();
    setupToggles();
    renderSizeList();
    updateDownloadButton();
  }

  // ============================================================================
  // File Upload
  // ============================================================================

  function setupFileUpload() {
    // Click to upload
    uploadContainer.addEventListener('click', () => {
      fileInput.click();
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
      const files = (e.target as HTMLInputElement).files;
      if (files && files[0]) {
        handleFile(files[0]);
      }
    });

    // Drag and drop
    uploadContainer.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadContainer.classList.add('dragover');
    });

    uploadContainer.addEventListener('dragleave', () => {
      uploadContainer.classList.remove('dragover');
    });

    uploadContainer.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadContainer.classList.remove('dragover');

      const files = e.dataTransfer?.files;
      if (files && files[0]) {
        handleFile(files[0]);
      }
    });

    // Clear button
    clearButton.addEventListener('click', (e) => {
      e.stopPropagation();
      clearUpload();
    });
  }

  function handleFile(file: File) {
    // Validate file type
    if (!isImageFile(file)) {
      showError('Please upload a valid image file (PNG, JPEG, etc.)');
      return;
    }

    clearError();

    // Update state
    state.uploadedFile = file;
    state.uploadedImageUrl = URL.createObjectURL(file);

    // Show preview
    previewImage.src = state.uploadedImageUrl;
    previewImage.onload = () => {
      const img = previewImage;
      imageDimensions.textContent = `${img.naturalWidth} × ${img.naturalHeight} px`;
    };

    uploadContainer.style.display = 'none';
    previewContainer.style.display = 'block';

    updateDownloadButton();
  }

  function clearUpload() {
    if (state.uploadedImageUrl) {
      URL.revokeObjectURL(state.uploadedImageUrl);
    }

    state.uploadedFile = null;
    state.uploadedImageUrl = null;

    previewImage.src = '';
    uploadContainer.style.display = 'flex';
    previewContainer.style.display = 'none';

    // Reset file input
    fileInput.value = '';

    updateDownloadButton();
  }

  // ============================================================================
  // Toggles
  // ============================================================================

  function setupToggles() {
    // Device toggle
    deviceToggle.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.hasAttribute('data-device')) {
        const device = target.getAttribute('data-device') as DeviceMode;
        setDevice(device);
      }
    });

    // Orientation toggle
    orientationToggle.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.hasAttribute('data-orientation')) {
        const orientation = target.getAttribute('data-orientation') as Orientation;
        setOrientation(orientation);
      }
    });
  }

  function setDevice(device: DeviceMode) {
    if (state.deviceMode === device) return;

    state.deviceMode = device;
    state.availableSizes = getSizesByDevice(device);
    state.selectedSizes.clear();

    // Update UI
    deviceToggle.querySelectorAll('.segmented-button').forEach((btn) => {
      const btnDevice = btn.getAttribute('data-device');
      btn.classList.toggle('active', btnDevice === device);
    });

    renderSizeList();
    updateDownloadButton();
  }

  function setOrientation(orientation: Orientation) {
    if (state.orientation === orientation) return;

    state.orientation = orientation;

    // Update UI
    orientationToggle.querySelectorAll('.segmented-button').forEach((btn) => {
      const btnOrientation = btn.getAttribute('data-orientation');
      btn.classList.toggle('active', btnOrientation === orientation);
    });

    renderSizeList();
  }

  // ============================================================================
  // Size List
  // ============================================================================

  function renderSizeList() {
    sizeListContainer.innerHTML = '';

    state.availableSizes.forEach((size) => {
      const { width, height } = getDimensionsForOrientation(size, state.orientation);
      const isChecked = state.selectedSizes.has(size.id);

      const item = document.createElement('label');
      item.className = 'checkbox-item';
      item.innerHTML = `
        <div class="checkbox-wrapper">
          <input type="checkbox" data-size-id="${size.id}" ${isChecked ? 'checked' : ''} />
          <div class="checkbox-custom ${isChecked ? 'checked' : ''}"></div>
        </div>
        <div class="flex-1">
          <div class="font-medium text-sm">${size.displayName} - ${width} × ${height}</div>
          ${size.description ? `<div class="text-tiny text-secondary mt-0.5">${size.description}</div>` : ''}
        </div>
      `;

      item.addEventListener('click', () => toggleSize(size.id));
      sizeListContainer.appendChild(item);
    });

    updateSelectAllCheckbox();
  }

  function toggleSize(sizeId: string) {
    if (state.selectedSizes.has(sizeId)) {
      state.selectedSizes.delete(sizeId);
    } else {
      state.selectedSizes.add(sizeId);
    }

    // Update checkbox visual state
    const checkbox = sizeListContainer.querySelector(`[data-size-id="${sizeId}"]`) as HTMLInputElement;
    const customCheckbox = checkbox?.nextElementSibling;

    if (checkbox) {
      checkbox.checked = state.selectedSizes.has(sizeId);
      customCheckbox?.classList.toggle('checked', checkbox.checked);
    }

    updateSelectAllCheckbox();
    updateDownloadButton();
  }

  function updateSelectAllCheckbox() {
    const allSelected = state.availableSizes.every((size) => state.selectedSizes.has(size.id));
    selectAllCheckbox.checked = allSelected;
    selectAllCheckbox.parentElement?.querySelector('.checkbox-custom')?.classList.toggle('checked', allSelected);
  }

  selectAllCheckbox.addEventListener('change', () => {
    const shouldSelectAll = selectAllCheckbox.checked;

    if (shouldSelectAll) {
      state.availableSizes.forEach((size) => state.selectedSizes.add(size.id));
    } else {
      state.selectedSizes.clear();
    }

    renderSizeList();
    updateDownloadButton();
  });

  // Select Common button handler
  const selectCommonButton = document.getElementById('select-common');
  selectCommonButton?.addEventListener('click', async () => {
    const { getCommonSizeIds } = await import('../data/screenshotSizes');
    const commonIds = getCommonSizeIds(state.deviceMode);

    // Clear all first
    state.selectedSizes.clear();

    // Add common sizes
    commonIds.forEach(id => {
      if (state.availableSizes.some(size => size.id === id)) {
        state.selectedSizes.add(id);
      }
    });

    renderSizeList();
    updateDownloadButton();
  });

  // ============================================================================
  // Download
  // ============================================================================

  function updateDownloadButton() {
    const hasFile = state.uploadedFile !== null;
    const hasSizes = state.selectedSizes.size > 0;
    const canDownload = hasFile && hasSizes && !state.isProcessing;

    downloadButton.disabled = !canDownload;

    // Update selected count text
    if (hasSizes) {
      const count = state.selectedSizes.size;
      selectedCount.textContent = `${count} size${count > 1 ? 's' : ''} selected`;
    } else {
      selectedCount.textContent = 'Select sizes to download';
    }
  }

  downloadButton.addEventListener('click', async () => {
    if (!state.uploadedFile || state.selectedSizes.size === 0) return;

    state.isProcessing = true;
    updateDownloadButton();

    // Show loading state
    buttonText.textContent = 'Generating...';
    buttonSpinner.style.display = 'inline-block';

    try {
      // Get selected sizes
      const selectedSizeObjects = state.availableSizes.filter((size) =>
        state.selectedSizes.has(size.id)
      );

      // Create ZIP with progress callback
      const zipBlob = await createScreenshotZip(
        state.uploadedFile,
        selectedSizeObjects,
        state.orientation,
        (current, total) => {
          buttonText.textContent = `Processing ${current}/${total}...`;
        }
      );

      // Download the ZIP
      const filename = generateZipFilename();
      downloadBlob(zipBlob, filename);

      clearError();
    } catch (error) {
      console.error('Failed to generate screenshots:', error);
      showError('Failed to generate screenshots. Please try again.');
    } finally {
      state.isProcessing = false;
      buttonText.textContent = 'Download Screenshots';
      buttonSpinner.style.display = 'none';
      updateDownloadButton();
    }
  });

  // ============================================================================
  // Error Handling
  // ============================================================================

  function showError(message: string) {
    state.error = message;
    errorText.textContent = message;
    errorContainer.style.display = 'block';
  }

  function clearError() {
    state.error = null;
    errorContainer.style.display = 'none';
  }
</script>

<style>
  /* Professional Layout System */
  .app-container {
    min-height: 100vh;
    padding: clamp(2rem, 5vw, 4rem) clamp(1.5rem, 4vw, 3rem);
  }

  .app-wrapper {
    max-width: 1400px;
    margin: 0 auto;
  }

  /* Hero Section - Left Aligned, Professional */
  .hero-section {
    margin-bottom: clamp(3rem, 6vw, 5rem);
    max-width: 900px;
  }

  .hero-content {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .title-group {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .hero-title {
    font-size: clamp(2rem, 4.5vw, 3.5rem);
    font-weight: 700;
    line-height: 1.15;
    letter-spacing: -0.02em;
    color: var(--color-text);
  }

  .hero-description {
    font-size: clamp(1.125rem, 2vw, 1.375rem);
    line-height: 1.6;
    color: var(--color-text-secondary);
    max-width: 65ch;
  }

  /* Content Grid - Responsive, Professional Spacing */
  .content-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
    align-items: start;
  }

  @media (min-width: 1024px) {
    .content-grid {
      grid-template-columns: 1.2fr 1fr;
      gap: 3rem;
    }
  }

  @media (min-width: 1400px) {
    .content-grid {
      gap: 4rem;
    }
  }

  /* Upload Section */
  .upload-section {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  /* Config Sidebar */
  .config-sidebar {
    position: sticky;
    top: 2rem;
  }

  .config-card {
    background: white;
    border-radius: 16px;
    padding: clamp(1.5rem, 3vw, 2.5rem);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05),
                0 4px 12px rgba(0, 0, 0, 0.04);
    border: 1px solid rgba(0, 0, 0, 0.06);
  }

  .config-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: 2rem;
    letter-spacing: -0.01em;
  }

  .config-group {
    padding-bottom: 1.75rem;
    margin-bottom: 1.75rem;
    border-bottom: 1px solid var(--color-gray-2);
  }

  .config-group:last-of-type {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }

  /* Download Section */
  .download-section {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-gray-2);
  }

  .download-section .btn-primary {
    width: 100%;
    margin-bottom: 1rem;
  }

  .selected-count {
    text-align: center;
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    font-weight: 500;
  }

  /* Mobile Optimizations */
  @media (max-width: 768px) {
    .title-group {
      flex-direction: column;
      gap: 0.75rem;
    }

    .hero-title {
      max-width: 100%;
    }

    .config-sidebar {
      position: static;
    }
  }

  /* Tablet Adjustments */
  @media (min-width: 768px) and (max-width: 1023px) {
    .content-grid {
      gap: 2.5rem;
    }
  }

  /* Large Screen Optimizations */
  @media (min-width: 1600px) {
    .app-wrapper {
      max-width: 1500px;
    }

    .hero-section {
      margin-bottom: 6rem;
    }
  }
</style>
